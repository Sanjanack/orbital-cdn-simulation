<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced User Dashboard - Orbital CDN Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --dark-bg: #1a1a2e;
            --card-bg: #16213e;
            --text-light: #ffffff;
            --text-muted: #b0b0b0;
            --text-dark: #1a1a2e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--card-bg) 100%);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Ensure all text is visible */
        .card-custom, .card-body, .card-header {
            color: var(--text-light) !important;
        }
        
        .form-label, label {
            color: var(--text-light) !important;
            font-weight: 500;
        }
        
        .text-muted {
            color: var(--text-muted) !important;
        }
        
        .form-control-custom, .form-control {
            background: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: var(--text-light) !important;
        }
        
        .form-control-custom::placeholder, .form-control::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
        }
        
        .form-control-custom:focus, .form-control:focus {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: var(--secondary-color) !important;
            color: var(--text-light) !important;
        }
        
        select.form-control-custom, select.form-control {
            color: var(--text-light) !important;
        }
        
        option {
            background: var(--card-bg);
            color: var(--text-light);
        }
        
        .list-group-item {
            background: rgba(255, 255, 255, 0.05) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-light) !important;
        }
        
        .list-group-item:hover, .list-group-item.active {
            background: rgba(52, 152, 219, 0.2) !important;
            color: var(--text-light) !important;
        }
        
        .modal-content {
            background: var(--card-bg) !important;
            color: var(--text-light) !important;
        }
        
        .modal-header, .modal-body, .modal-footer {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        
        .btn-close-white {
            filter: invert(1);
        }
        
        h1, h2, h3, h4, h5, h6, p, span, div {
            color: var(--text-light);
        }
        
        .card-title-custom, .card-title {
            color: var(--secondary-color) !important;
        }
        
        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .satellite-orbit {
            position: absolute;
            width: 300px;
            height: 300px;
            border: 2px dashed rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: orbit 20s linear infinite;
        }
        
        .satellite-icon {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            color: var(--secondary-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes orbit {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.2); opacity: 0.8; }
        }
        
        .navbar-custom {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .dashboard-container {
            padding: 30px 0;
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-custom {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: cardSlideIn 0.6s ease-out;
            animation-fill-mode: both;
        }
        
        .card-custom:nth-child(1) { animation-delay: 0.1s; }
        .card-custom:nth-child(2) { animation-delay: 0.2s; }
        .card-custom:nth-child(3) { animation-delay: 0.3s; }
        .card-custom:nth-child(4) { animation-delay: 0.4s; }
        
        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .card-custom:hover {
            transform: translateY(-5px);
            border-color: var(--secondary-color);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.2);
        }
        
        /* Data Transmission Animation */
        .data-transmission {
            position: relative;
            height: 200px;
            overflow: hidden;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .data-packet {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--secondary-color);
            border-radius: 50%;
            animation: transmit 3s infinite;
            box-shadow: 0 0 10px var(--secondary-color);
        }
        
        @keyframes transmit {
            0% {
                left: -20px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                left: 100%;
                opacity: 0;
            }
        }
        
        /* Cache Hit/Miss Animation */
        .cache-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            animation: bounceIn 0.5s ease-out;
        }
        
        .cache-hit {
            background: rgba(39, 174, 96, 0.3) !important;
            color: var(--success-color) !important;
            border: 2px solid var(--success-color) !important;
        }
        
        .cache-miss {
            background: rgba(231, 76, 60, 0.2);
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
        }
        
        @keyframes bounceIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Message Chat Animation */
        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 10px;
            animation: messageSlide 0.3s ease-out;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        .message-sent {
            background: var(--secondary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message-received {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border-bottom-left-radius: 4px;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Satellite Network Visualization */
        .network-visualization {
            position: relative;
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .network-node {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            animation: nodePulse 2s infinite;
        }
        
        .node-satellite {
            background: radial-gradient(circle, var(--secondary-color), #2980b9);
            box-shadow: 0 0 20px var(--secondary-color);
        }
        
        .node-user {
            background: radial-gradient(circle, var(--success-color), #229954);
            box-shadow: 0 0 15px var(--success-color);
        }
        
        .node-ground {
            background: radial-gradient(circle, var(--warning-color), #d68910);
            box-shadow: 0 0 15px var(--warning-color);
        }
        
        @keyframes nodePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 15px currentColor;
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 25px currentColor;
            }
        }
        
        .network-connection {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--secondary-color), transparent);
            animation: dataFlow 2s infinite;
        }
        
        @keyframes dataFlow {
            0% {
                opacity: 0.3;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.3;
            }
        }
        
        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(52, 152, 219, 0.3);
            border-top-color: var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Real-time Stats Animation */
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            transition: all 0.3s ease;
        }
        
        .stat-value.updated {
            animation: numberUpdate 0.5s ease-out;
        }
        
        @keyframes numberUpdate {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
                color: var(--success-color);
            }
            100% {
                transform: scale(1);
            }
        }
        
        /* Content Stream Visualization */
        .content-stream {
            position: relative;
            height: 150px;
            overflow: hidden;
            border-radius: 10px;
            background: linear-gradient(90deg, 
                rgba(52, 152, 219, 0.1) 0%, 
                rgba(52, 152, 219, 0.3) 50%, 
                rgba(52, 152, 219, 0.1) 100%);
        }
        
        /* Content Delivery Status */
        .delivery-status {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .delivery-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            color: var(--text-light);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .delivery-step:last-child {
            border-bottom: none;
        }
        
        .delivery-step.completed {
            color: var(--success-color);
        }
        
        .delivery-step.active {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .delivery-step.pending {
            color: var(--text-muted);
        }
        
        .stream-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: var(--secondary-color);
            animation: streamUp 1s ease-out infinite;
            opacity: 0.7;
        }
        
        @keyframes streamUp {
            from {
                height: 0;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            to {
                height: 100%;
                opacity: 0;
            }
        }
        
        .btn-animated {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .btn-animated::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-animated:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-animated:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }
        
        /* Tab Animation */
        .tab-content {
            animation: fadeInTab 0.3s ease-out;
        }
        
        @keyframes fadeInTab {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            animation: badgePulse 1s infinite;
        }
        
        @keyframes badgePulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .network-visualization {
                height: 300px;
            }
            
            .stat-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg" id="animatedBg"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-satellite me-2"></i>Orbital CDN
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="nav-link">
                            <i class="fas fa-user me-2"></i>{{ current_user.username }}
                        </span>
                    </li>
                    <li class="nav-item position-relative">
                        <a class="nav-link" href="#" id="messagesBtn" data-bs-toggle="modal" data-bs-target="#messagesModal">
                            <i class="fas fa-envelope me-2"></i>Messages
                            <span class="notification-badge" id="messageBadge" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="dashboard-container" style="margin-top: 80px;">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="card card-custom mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="mb-2">Welcome back, {{ current_user.username }}!</h1>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-2"></i>Member since {{ current_user.created_at.strftime('%B %d, %Y') }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex flex-column align-items-end">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="status-indicator status-running me-2" id="satelliteIndicator"></span>
                                    <span id="connectionStatus" style="font-weight: 600; color: var(--success-color);">Checking Connection...</span>
                                </div>
                                <small id="satelliteInfo" style="color: var(--text-muted); font-size: 0.85rem;">LEO-1 • Altitude: 550 km</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Tabs -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button">
                        <i class="fas fa-cloud-download-alt me-2"></i>Content Request
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button">
                        <i class="fas fa-project-diagram me-2"></i>Network View
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button">
                        <i class="fas fa-chart-line me-2"></i>Analytics
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="simulation-tab" data-bs-toggle="tab" data-bs-target="#simulation" type="button">
                        <i class="fas fa-rocket me-2"></i>Simulation
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="multi-satellite-tab" data-bs-toggle="tab" data-bs-target="#multi-satellite" type="button">
                        <i class="fas fa-satellite-dish me-2"></i>Multi-Satellite
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button">
                        <i class="fas fa-question-circle me-2"></i>Help & Guide
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <!-- Content Request Tab -->
                <div class="tab-pane fade show active" id="content" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card card-custom mb-4">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Request Content</h5>
                                </div>
                                <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label" style="color: var(--text-light); font-weight: 600;">Content Type</label>
                                    <select class="form-control form-control-custom" id="contentTypeFilter">
                                        <option value="">All Types</option>
                                        <option value="video">Video</option>
                                        <option value="image">Image</option>
                                        <option value="document">Document</option>
                                        <option value="audio">Audio</option>
                                        <option value="application">Application</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" style="color: var(--text-light); font-weight: 600;">Size Range (MB)</label>
                                    <select class="form-control form-control-custom" id="sizeFilter">
                                        <option value="">All Sizes</option>
                                        <option value="0-10">Small (0-10 MB)</option>
                                        <option value="10-50">Medium (10-50 MB)</option>
                                        <option value="50-100">Large (50-100 MB)</option>
                                        <option value="100+">Very Large (100+ MB)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" style="color: var(--text-light); font-weight: 600;">Select Content</label>
                                    <select class="form-control form-control-custom" id="contentSelector" required>
                                        <option value="">-- Select Content --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted" style="color: var(--text-muted);">
                                    <i class="fas fa-info-circle me-1"></i>Filter by type/size, then select content to request
                                </small>
                            </div>
                            
                            <div id="selectedContentInfo" style="display: none; background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(52, 152, 219, 0.3);">
                                <h6 style="color: var(--secondary-color); margin-bottom: 10px;" id="selectedTitle"></h6>
                                <p style="color: var(--text-light); margin: 5px 0; font-size: 0.9rem;" id="selectedDescription"></p>
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <small style="color: var(--text-muted);"><strong>Type:</strong> <span id="selectedType"></span></small>
                                    </div>
                                    <div class="col-md-4">
                                        <small style="color: var(--text-muted);"><strong>Size:</strong> <span id="selectedSize"></span> MB</small>
                                    </div>
                                    <div class="col-md-4">
                                        <small style="color: var(--text-muted);"><strong>Category:</strong> <span id="selectedCategory"></span></small>
                                    </div>
                                </div>
                            </div>
                            
                            <form id="requestForm">
                                <input type="hidden" id="hiddenContentId" name="content_id">
                                <div class="mt-3">
                                    <button type="submit" class="btn btn-primary btn-animated" id="requestBtn" disabled>
                                        <i class="fas fa-satellite-dish me-2"></i>Request from Satellite CDN
                                    </button>
                                    <button type="button" class="btn btn-outline-info ms-2" onclick="loadAvailableContent()">
                                        <i class="fas fa-sync me-2"></i>Refresh Catalog
                                    </button>
                                </div>
                            </form>
                                    
                                    <!-- Data Transmission Visualization -->
                                    <div class="data-transmission mt-4" id="dataTransmission"></div>
                                    
                                    <!-- Request Result -->
                                    <div class="mt-4" id="requestResult"></div>
                                </div>
                            </div>
                            
                            <!-- Content Stream -->
                            <div class="card card-custom">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-stream me-2"></i>Content Stream</h5>
                                </div>
                                <div class="card-body">
                                    <div class="content-stream" id="contentStream"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <!-- Real-time Stats -->
                            <div class="card card-custom mb-4">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Real-time Stats</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Cache Hit Rate</span>
                                            <span class="stat-value" id="hitRate">0%</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-success" id="hitRateBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Cache Utilization</span>
                                            <span class="stat-value" id="cacheUtil">0%</span>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-info" id="cacheUtilBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Total Requests</span>
                                            <span class="stat-value" id="totalRequests">0</span>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Delivery Speed</span>
                                            <span class="stat-value" id="deliverySpeed">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Satellite Status -->
                            <div class="card card-custom">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-satellite me-2"></i>Satellite Connection</h5>
                                </div>
                                <div class="card-body">
                                    <div id="satelliteStatus">
                                        <div style="text-align: center; padding: 20px;">
                                            <div class="spinner-border text-primary mb-3" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p style="color: var(--text-muted);">Checking satellite connection...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Network View Tab -->
                <div class="tab-pane fade" id="network" role="tabpanel">
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-transparent border-0 p-3">
                            <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Satellite Network Topology</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="background: rgba(52, 152, 219, 0.2); border-color: var(--secondary-color); color: var(--text-light); margin-bottom: 20px;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>What is this?</strong> This shows how your device connects to the satellite network. 
                                The icons represent different parts of the system.
                            </div>
                            <div class="network-visualization" id="networkVisualization">
                                <!-- Network nodes will be dynamically added -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="card card-custom">
                        <div class="card-header bg-transparent border-0 p-3">
                            <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>What Do the Icons Mean?</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px; border: 2px solid var(--secondary-color); text-align: center;">
                                        <div style="font-size: 3rem; color: var(--secondary-color); margin-bottom: 15px;">
                                            <i class="fas fa-satellite"></i>
                                        </div>
                                        <h6 style="color: var(--secondary-color); margin-bottom: 10px;">Satellite Icon</h6>
                                        <p style="color: var(--text-light); margin: 0; font-size: 0.9rem;">
                                            This is the satellite in space. It stores content in its cache (like a temporary storage) 
                                            and sends it to you when you request something. It's floating in space at about 550 km above Earth.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div style="background: rgba(39, 174, 96, 0.1); padding: 20px; border-radius: 10px; border: 2px solid var(--success-color); text-align: center;">
                                        <div style="font-size: 3rem; color: var(--success-color); margin-bottom: 15px;">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <h6 style="color: var(--success-color); margin-bottom: 10px;">User Icon</h6>
                                        <p style="color: var(--text-light); margin: 0; font-size: 0.9rem;">
                                            This represents you and other users. When you click "Request Content", 
                                            your device sends a request to the satellite asking for videos, images, or other files.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; border: 2px solid var(--warning-color); text-align: center;">
                                        <div style="font-size: 3rem; color: var(--warning-color); margin-bottom: 15px;">
                                            <i class="fas fa-server"></i>
                                        </div>
                                        <h6 style="color: var(--warning-color); margin-bottom: 10px;">Ground Station Icon</h6>
                                        <p style="color: var(--text-light); margin: 0; font-size: 0.9rem;">
                                            This is a computer on Earth that stores all the content. If the satellite doesn't have 
                                            what you want in its cache, it asks the ground station to send it. This is slower but has everything.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4" style="background: rgba(52, 152, 219, 0.15); padding: 20px; border-radius: 10px; border: 1px solid rgba(52, 152, 219, 0.3);">
                                <h6 style="color: var(--secondary-color); margin-bottom: 15px;">
                                    <i class="fas fa-lightbulb me-2"></i>How It Works:
                                </h6>
                                <ol style="color: var(--text-light); margin: 0; padding-left: 20px;">
                                    <li style="margin-bottom: 10px;">You (User icon) request a video or file</li>
                                    <li style="margin-bottom: 10px;">Your request goes to the Satellite (Satellite icon)</li>
                                    <li style="margin-bottom: 10px;">Satellite checks if it has the file in its cache (fast storage)</li>
                                    <li style="margin-bottom: 10px;">If yes → You get it quickly! (Cache HIT - very fast)</li>
                                    <li style="margin-bottom: 10px;">If no → Satellite asks Ground Station (Server icon) for the file</li>
                                    <li>Ground Station sends it to Satellite, then Satellite sends it to you (Cache MISS - slower)</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Tab -->
                <div class="tab-pane fade" id="analytics" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-custom mb-4">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0">Performance Chart</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="performanceChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card card-custom mb-4">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0">Content Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="contentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Simulation Tab -->
                <div class="tab-pane fade" id="simulation" role="tabpanel">
                    <div class="card card-custom mb-4">
                        <div class="card-header bg-transparent border-0 p-3">
                            <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>Run Time-Based Simulation</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info" style="background: rgba(52, 152, 219, 0.2); border-color: var(--secondary-color); color: var(--text-light); margin-bottom: 20px;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>What is this?</strong> This runs a simulation where multiple users request content over time. 
                                Results will appear in the Analytics tab after completion.
                            </div>
                            <form id="simulationForm">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Duration (time units)</label>
                                        <input type="number" class="form-control form-control-custom" name="simulation_duration" value="200" min="50" max="1000" required>
                                        <small class="text-muted">How long the simulation runs</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Request Interval</label>
                                        <input type="number" class="form-control form-control-custom" name="request_interval" value="3" min="1" max="20" step="0.5" required>
                                        <small class="text-muted">Time between requests</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Cache Size</label>
                                        <input type="number" class="form-control form-control-custom" name="cache_size" value="12" min="5" max="50" required>
                                        <small class="text-muted">Maximum items in cache</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">User Count</label>
                                        <input type="number" class="form-control form-control-custom" name="user_count" value="4" min="1" max="20" required>
                                        <small class="text-muted">Number of simulated users</small>
                                    </div>
                                </div>
                                <div class="mt-4 text-center">
                                    <button type="submit" class="btn btn-success btn-animated btn-lg">
                                        <i class="fas fa-play me-2"></i>Start Simulation
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Multi-Satellite Tab -->
                <div class="tab-pane fade" id="multi-satellite" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card card-custom mb-4">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-satellite-dish me-2"></i>Multi-Satellite Constellation</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-success" style="background: rgba(39, 174, 96, 0.2); border-color: var(--success-color); color: var(--text-light); margin-bottom: 20px;">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>Feature Enabled!</strong> Multi-satellite constellation allows satellites to share content with each other, 
                                        improving cache hit rates by 10-20%.
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="form-label">Number of Satellites</label>
                                        <select class="form-control form-control-custom" id="numSatellites">
                                            <option value="3">3 Satellites</option>
                                            <option value="5" selected>5 Satellites (Recommended)</option>
                                            <option value="7">7 Satellites</option>
                                            <option value="10">10 Satellites</option>
                                        </select>
                                        <small class="text-muted">More satellites = better coverage but higher complexity</small>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <button class="btn btn-primary btn-animated" onclick="enableMultiSatellite()">
                                            <i class="fas fa-satellite me-2"></i>Enable Multi-Satellite Mode
                                        </button>
                                        <button class="btn btn-outline-info ms-2" onclick="loadConstellationStats()">
                                            <i class="fas fa-sync me-2"></i>Refresh Stats
                                        </button>
                                    </div>
                                    
                                    <div id="constellationStatus" style="min-height: 100px;">
                                        <p class="text-muted">Click "Enable Multi-Satellite Mode" to activate constellation</p>
                                    </div>
                                    
                                    <div id="constellationVisualization" class="mt-4" style="min-height: 300px;">
                                        <!-- Constellation visualization will appear here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card card-custom">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>How Multi-Satellite Works</h5>
                                </div>
                                <div class="card-body">
                                    <div class="delivery-status">
                                        <div class="delivery-step completed" style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="display: flex; align-items: center;">
                                                <i class="fas fa-check-circle me-3" style="color: var(--success-color); font-size: 1.5rem;"></i>
                                                <div>
                                                    <strong style="color: var(--text-light);">Step 1:</strong> User requests content from assigned satellite
                                                </div>
                                            </div>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="display: flex; align-items: center;">
                                                <i class="fas fa-check-circle me-3" style="color: var(--success-color); font-size: 1.5rem;"></i>
                                                <div>
                                                    <strong style="color: var(--text-light);">Step 2:</strong> Satellite checks its local cache
                                                </div>
                                            </div>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="display: flex; align-items: center;">
                                                <i class="fas fa-satellite me-3" style="color: var(--secondary-color); font-size: 1.5rem;"></i>
                                                <div>
                                                    <strong style="color: var(--text-light);">Step 3:</strong> If not found, checks neighboring satellites (Inter-Satellite Communication)
                                                </div>
                                            </div>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="display: flex; align-items: center;">
                                                <i class="fas fa-check-circle me-3" style="color: var(--success-color); font-size: 1.5rem;"></i>
                                                <div>
                                                    <strong style="color: var(--text-light);">Step 4:</strong> If found in neighbor, transfers via inter-satellite link
                                                </div>
                                            </div>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(231, 76, 60, 0.1); padding: 15px; border-radius: 8px;">
                                            <div style="display: flex; align-items: center;">
                                                <i class="fas fa-server me-3" style="color: var(--accent-color); font-size: 1.5rem;"></i>
                                                <div>
                                                    <strong style="color: var(--text-light);">Step 5:</strong> Only if not found anywhere, fetches from ground station
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4" style="background: rgba(52, 152, 219, 0.15); padding: 20px; border-radius: 10px; border: 1px solid rgba(52, 152, 219, 0.3);">
                                        <h6 style="color: var(--secondary-color); margin-bottom: 15px;">
                                            <i class="fas fa-lightbulb me-2"></i>Benefits:
                                        </h6>
                                        <ul style="color: var(--text-light); margin: 0; padding-left: 20px;">
                                            <li>10-20% improvement in cache hit rates</li>
                                            <li>Reduced latency through inter-satellite communication</li>
                                            <li>Better load balancing across satellites</li>
                                            <li>Improved coverage and redundancy</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card card-custom">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Constellation Statistics</h5>
                                </div>
                                <div class="card-body" id="constellationStatsPanel">
                                    <p class="text-muted text-center">Enable multi-satellite mode to see statistics</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Help & Guide Tab -->
                <div class="tab-pane fade" id="help" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card card-custom mb-4">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>Quick Start Guide</h5>
                                </div>
                                <div class="card-body">
                                    <div class="delivery-status">
                                        <div class="delivery-step completed" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <strong style="color: var(--secondary-color);">Step 1:</strong> 
                                            <span style="color: var(--text-light);">Go to "Content Request" tab</span>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <strong style="color: var(--secondary-color);">Step 2:</strong> 
                                            <span style="color: var(--text-light);">Select content type and size (optional filters)</span>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <strong style="color: var(--secondary-color);">Step 3:</strong> 
                                            <span style="color: var(--text-light);">Choose content from dropdown</span>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                            <strong style="color: var(--secondary-color);">Step 4:</strong> 
                                            <span style="color: var(--text-light);">Click "Request from Satellite CDN"</span>
                                        </div>
                                        <div class="delivery-step completed" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px;">
                                            <strong style="color: var(--secondary-color);">Step 5:</strong> 
                                            <span style="color: var(--text-light);">View delivery process and results!</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card card-custom">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-star me-2"></i>Key Features</h5>
                                </div>
                                <div class="card-body">
                                    <div style="color: var(--text-light);">
                                        <div class="mb-3" style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--success-color);">
                                            <h6 style="color: var(--success-color); margin-bottom: 5px;">
                                                <i class="fas fa-check-circle me-2"></i>Advanced Caching
                                            </h6>
                                            <p style="margin: 0; font-size: 0.9rem;">LRU, LFU, FIFO, and Adaptive caching strategies</p>
                                        </div>
                                        
                                        <div class="mb-3" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--secondary-color);">
                                            <h6 style="color: var(--secondary-color); margin-bottom: 5px;">
                                                <i class="fas fa-satellite-dish me-2"></i>Multi-Satellite Support
                                            </h6>
                                            <p style="margin: 0; font-size: 0.9rem;">Multiple satellites working together with inter-satellite communication</p>
                                        </div>
                                        
                                        <div class="mb-3" style="background: rgba(243, 156, 18, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-color);">
                                            <h6 style="color: var(--warning-color); margin-bottom: 5px;">
                                                <i class="fas fa-users me-2"></i>Real-time Collaboration
                                            </h6>
                                            <p style="margin: 0; font-size: 0.9rem;">Multi-user sessions with live updates via WebSocket</p>
                                        </div>
                                        
                                        <div style="background: rgba(155, 89, 182, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #9b59b6;">
                                            <h6 style="color: #9b59b6; margin-bottom: 5px;">
                                                <i class="fas fa-chart-bar me-2"></i>Comprehensive Analytics
                                            </h6>
                                            <p style="margin: 0; font-size: 0.9rem;">Real-time performance metrics and visualizations</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card card-custom mb-4">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Understanding Cache Hit/Miss</h5>
                                </div>
                                <div class="card-body">
                                    <div style="color: var(--text-light);">
                                        <div class="mb-3" style="background: rgba(39, 174, 96, 0.2); padding: 15px; border-radius: 8px; border: 2px solid var(--success-color);">
                                            <h6 style="color: var(--success-color); margin-bottom: 10px;">
                                                <i class="fas fa-check-circle me-2"></i>Cache HIT
                                            </h6>
                                            <p style="margin: 0;">Content found in satellite cache. Delivered instantly (~0.15 seconds). Very fast!</p>
                                        </div>
                                        
                                        <div style="background: rgba(231, 76, 60, 0.2); padding: 15px; border-radius: 8px; border: 2px solid var(--accent-color);">
                                            <h6 style="color: var(--accent-color); margin-bottom: 10px;">
                                                <i class="fas fa-times-circle me-2"></i>Cache MISS
                                            </h6>
                                            <p style="margin: 0;">Content not in cache. Fetched from ground station (~1.5+ seconds). Slower, but next request will be faster!</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card card-custom">
                                <div class="card-header bg-transparent border-0 p-3">
                                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Tips & Best Practices</h5>
                                </div>
                                <div class="card-body">
                                    <div style="color: var(--text-light);">
                                        <p><strong>For Better Understanding:</strong></p>
                                        <ul style="margin-bottom: 20px;">
                                            <li>Request the same content twice to see cache HIT (much faster!)</li>
                                            <li>Try different content types to see variety in delivery</li>
                                            <li>Enable multi-satellite mode to see advanced features</li>
                                            <li>Check Analytics tab for performance metrics</li>
                                            <li>Use Messages feature to communicate with other users</li>
                                        </ul>
                                        
                                        <p><strong>Key Features to Explore:</strong></p>
                                        <ul>
                                            <li>Realistic network latency calculations</li>
                                            <li>Step-by-step delivery visualization</li>
                                            <li>Multiple caching strategies (LRU, LFU, FIFO, Adaptive)</li>
                                            <li>Inter-satellite communication</li>
                                            <li>Real-time performance tracking</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Messages Modal -->
    <div class="modal fade" id="messagesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--card-bg); color: var(--text-light);">
                <div class="modal-header border-0">
                    <h5 class="modal-title"><i class="fas fa-envelope me-2"></i>Messages</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 border-end">
                            <h6>Users</h6>
                            <div id="usersList" class="list-group list-group-flush"></div>
                        </div>
                        <div class="col-md-8">
                            <div id="messagesContainer" style="height: 400px; overflow-y: auto; padding: 10px;">
                                <p class="text-muted text-center">Select a user to start messaging</p>
                            </div>
                            <div class="mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-custom" id="messageInput" 
                                           placeholder="Type a message and press Enter..." 
                                           style="color: var(--text-light);">
                                    <button class="btn btn-primary" onclick="sendMessage()" id="sendMessageBtn">
                                        <i class="fas fa-paper-plane"></i> Send
                                    </button>
                                </div>
                                <small class="text-muted" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px; display: block;">
                                    <i class="fas fa-info-circle me-1"></i>Select a user from the left, then type and send messages
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize animated background
        function initAnimatedBackground() {
            const bg = document.getElementById('animatedBg');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                bg.appendChild(star);
            }
        }
        
        // Initialize network visualization
        function initNetworkVisualization() {
            const network = document.getElementById('networkVisualization');
            if (!network) return;
            
            // Add satellite node
            const satellite = document.createElement('div');
            satellite.className = 'network-node node-satellite';
            satellite.style.top = '50%';
            satellite.style.left = '50%';
            satellite.innerHTML = '<i class="fas fa-satellite"></i>';
            network.appendChild(satellite);
            
            // Add user nodes
            for (let i = 0; i < 3; i++) {
                const user = document.createElement('div');
                user.className = 'network-node node-user';
                user.style.top = (20 + i * 30) + '%';
                user.style.left = (10 + i * 20) + '%';
                user.innerHTML = '<i class="fas fa-user"></i>';
                user.style.animationDelay = i * 0.3 + 's';
                network.appendChild(user);
            }
            
            // Add ground station
            const ground = document.createElement('div');
            ground.className = 'network-node node-ground';
            ground.style.bottom = '10%';
            ground.style.left = '50%';
            ground.innerHTML = '<i class="fas fa-server"></i>';
            network.appendChild(ground);
        }
        
        // Load available content with filters
        async function loadAvailableContent() {
            try {
                const typeFilter = document.getElementById('contentTypeFilter').value;
                const sizeFilter = document.getElementById('sizeFilter').value;
                
                let url = '/api/available_content';
                const params = new URLSearchParams();
                if (typeFilter) params.append('type', typeFilter);
                if (sizeFilter) params.append('size', sizeFilter);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    const selector = document.getElementById('contentSelector');
                    selector.innerHTML = '<option value="">-- Select Content --</option>';
                    
                    if (data.content.length === 0) {
                        selector.innerHTML = '<option value="">No content found with selected filters</option>';
                    } else {
                        // Filter out unavailable content
                        const availableContent = data.content.filter(item => {
                            // Remove items marked as unavailable or with invalid data
                            return item.content_id && 
                                   item.title && 
                                   item.title.toLowerCase().indexOf('unavailable') === -1 &&
                                   item.size_mb > 0 &&
                                   item.content_id !== 'unavailable';
                        });
                        
                        if (availableContent.length === 0) {
                            selector.innerHTML = '<option value="">No available content found</option>';
                        } else {
                            availableContent.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item.content_id;
                                option.textContent = `${item.title} (${item.type}, ${item.size_mb} MB)`;
                                option.dataset.content = JSON.stringify(item);
                                selector.appendChild(option);
                            });
                        }
                    }
                    
                    // Enable selector change handler
                    selector.onchange = function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption.value) {
                            const content = JSON.parse(selectedOption.dataset.content);
                            showSelectedContent(content);
                            document.getElementById('hiddenContentId').value = content.content_id;
                            document.getElementById('requestBtn').disabled = false;
                        } else {
                            document.getElementById('selectedContentInfo').style.display = 'none';
                            document.getElementById('requestBtn').disabled = true;
                        }
                    };
                }
            } catch (error) {
                console.error('Error loading content:', error);
            }
        }
        
        // Filter change handlers
        document.getElementById('contentTypeFilter').addEventListener('change', loadAvailableContent);
        document.getElementById('sizeFilter').addEventListener('change', loadAvailableContent);
        
        // Show selected content info
        function showSelectedContent(content) {
            document.getElementById('selectedContentInfo').style.display = 'block';
            document.getElementById('selectedTitle').textContent = content.title;
            document.getElementById('selectedDescription').textContent = content.description;
            document.getElementById('selectedType').textContent = content.type;
            document.getElementById('selectedSize').textContent = content.size_mb;
            document.getElementById('selectedCategory').textContent = content.category;
        }
        
        // Handle content request
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const contentId = document.getElementById('hiddenContentId').value;
            
            if (!contentId) {
                alert('Please select content first');
                return;
            }
            
            showLoading();
            animateDataTransmission();
            
            try {
                const response = await fetch('/api/request_content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content_id: contentId })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.connected && data.content_delivered) {
                    showRequestResult(data);
                    updateStats(data);
                    animateContentStream();
                    showContentDelivery(data.content_received);
                } else {
                    alert('Request failed: ' + (data.error || 'unknown error'));
                    if (data.steps) {
                        showRequestResult(data);
                    }
                }
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // Show actual content delivery
        function showContentDelivery(content) {
            const resultDiv = document.getElementById('requestResult');
            const deliveryDiv = document.createElement('div');
            deliveryDiv.className = 'mt-4';
            deliveryDiv.innerHTML = `
                <div style="background: rgba(39, 174, 96, 0.2); border: 2px solid var(--success-color); border-radius: 15px; padding: 20px;">
                    <h5 style="color: var(--success-color); margin-bottom: 15px;">
                        <i class="fas fa-check-circle me-2"></i>Content Successfully Delivered!
                    </h5>
                    <div style="color: var(--text-light);">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Title:</strong> ${content.title}</p>
                                <p><strong>Content ID:</strong> ${content.content_id}</p>
                                <p><strong>Type:</strong> ${content.content_type}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Size:</strong> ${content.size_mb} MB</p>
                                <p><strong>Category:</strong> ${content.category}</p>
                                <p><strong>Received At:</strong> ${new Date(content.received_at).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="mt-3" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
                            <p style="margin: 0;"><strong>Description:</strong></p>
                            <p style="margin: 5px 0 0 0; color: var(--text-muted);">${content.description}</p>
                        </div>
                        <div class="mt-3 text-center">
                            <button class="btn btn-success" onclick="viewContent('${content.content_id}')">
                                <i class="fas fa-eye me-2"></i>View Content
                            </button>
                            <button class="btn btn-outline-light ms-2" onclick="downloadContent('${content.content_id}')">
                                <i class="fas fa-download me-2"></i>Download
                            </button>
                        </div>
                    </div>
                </div>
            `;
            resultDiv.appendChild(deliveryDiv);
        }
        
        function viewContent(contentId) {
            alert(`Viewing content: ${contentId}\n\nIn a real system, this would open the content viewer.`);
        }
        
        function downloadContent(contentId) {
            alert(`Downloading content: ${contentId}\n\nIn a real system, this would initiate download.`);
        }
        
        // Animate data transmission
        function animateDataTransmission() {
            const container = document.getElementById('dataTransmission');
            container.innerHTML = '';
            
            for (let i = 0; i < 5; i++) {
                const packet = document.createElement('div');
                packet.className = 'data-packet';
                packet.style.top = (30 + i * 30) + 'px';
                packet.style.animationDelay = i * 0.3 + 's';
                container.appendChild(packet);
            }
        }
        
        // Show request result with animation and content delivery confirmation
        function showRequestResult(data) {
            const resultDiv = document.getElementById('requestResult');
            // Fix: Cache HIT should be green (positive), MISS should be red
            const statusClass = (data.status === 'HIT' || data.status === 'Hit') ? 'cache-hit' : 'cache-miss';
            
            // Show realistic satellite communication steps
            let stepsHtml = '';
            if (data.steps && data.steps.length > 0) {
                stepsHtml = '<div class="delivery-status mt-3"><h6 style="color: var(--text-light); margin-bottom: 15px; font-weight: 600;">Satellite Communication Process:</h6>';
                
                data.steps.forEach((step, index) => {
                    const isLast = step.action === 'delivery_complete';
                    const isError = step.action === 'error';
                    const isHit = step.action === 'cache_hit';
                    const isMiss = step.action === 'cache_miss';
                    
                    let stepClass = 'pending';
                    let icon = 'circle';
                    let iconColor = 'var(--text-muted)';
                    let bgColor = 'rgba(255,255,255,0.05)';
                    
                    if (isLast || isHit) {
                        stepClass = 'completed';
                        icon = 'check-circle';
                        iconColor = 'var(--success-color)';
                        bgColor = 'rgba(39, 174, 96, 0.1)';
                    } else if (isError || isMiss) {
                        icon = 'times-circle';
                        iconColor = 'var(--accent-color)';
                        bgColor = 'rgba(231, 76, 60, 0.1)';
                    } else if (step.action === 'satellite_receive' || step.action === 'satellite_delivery') {
                        icon = 'satellite';
                        iconColor = 'var(--secondary-color)';
                        bgColor = 'rgba(52, 152, 219, 0.1)';
                    }
                    
                    const latencyInfo = step.latency_ms ? ` <span style="color: var(--text-muted); font-size: 0.85rem;">(${step.latency_ms.toFixed(1)}ms)</span>` : '';
                    const locationInfo = step.location ? ` <span style="color: var(--secondary-color); font-size: 0.85rem;">[${step.location}]</span>` : '';
                    
                    stepsHtml += `
                        <div class="delivery-step ${stepClass}" style="animation-delay: ${index * 0.15}s; background: ${bgColor}; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-${icon} me-2" style="color: ${iconColor}; width: 20px;"></i>
                                <div style="flex: 1;">
                                    <div style="color: var(--text-light);">${step.message}${latencyInfo}</div>
                                    ${locationInfo}
                                    ${step.bandwidth_mbps ? `<div style="color: var(--text-muted); font-size: 0.8rem; margin-top: 3px;">Bandwidth: ${step.bandwidth_mbps} Mbps</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add latency comparison if available
                if (data.performance && data.performance.speed_comparison) {
                    const comp = data.performance.speed_comparison;
                    stepsHtml += `
                        <div style="background: rgba(52, 152, 219, 0.15); padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid rgba(52, 152, 219, 0.3);">
                            <h6 style="color: var(--secondary-color); margin-bottom: 10px;">Latency Comparison:</h6>
                            <div style="color: var(--text-light);">
                                <p style="margin: 5px 0;"><strong>From Satellite Cache:</strong> ${comp.from_satellite}</p>
                                <p style="margin: 5px 0;"><strong>From Ground Station:</strong> ${comp.from_ground}</p>
                                <p style="margin: 5px 0; color: var(--success-color);"><strong>Speed Advantage:</strong> ${comp.advantage}</p>
                            </div>
                        </div>
                    `;
                }
                
                stepsHtml += '</div>';
            } else if (data.fetch_steps && data.fetch_steps.length > 0) {
                // Fallback to old format
                stepsHtml = '<div class="delivery-status mt-3"><h6 style="color: var(--text-light); margin-bottom: 15px; font-weight: 600;">Delivery Process:</h6>';
                data.fetch_steps.forEach((step, index) => {
                    const isLast = index === data.fetch_steps.length - 1;
                    stepsHtml += `
                        <div class="delivery-step ${isLast ? 'completed' : 'pending'}" style="animation-delay: ${index * 0.2}s;">
                            <i class="fas fa-${isLast ? 'check-circle' : 'circle'} me-2" style="color: ${isLast ? 'var(--success-color)' : 'var(--text-muted)'}; width: 20px;"></i>
                            <span>${step}</span>
                        </div>
                    `;
                });
                stepsHtml += '</div>';
            }
            
            // Content delivery confirmation
            let contentReceivedHtml = '';
            if (data.content_delivered && data.content_received) {
                contentReceivedHtml = `
                    <div class="mt-3 p-3" style="background: rgba(39, 174, 96, 0.2); border: 2px solid var(--success-color); border-radius: 10px;">
                        <h6 style="color: var(--success-color); margin-bottom: 10px;">
                            <i class="fas fa-check-circle me-2"></i>Content Successfully Received!
                        </h6>
                        <div style="color: var(--text-light);">
                            <p><strong>Content ID:</strong> ${data.content_received.content_id}</p>
                            <p><strong>Type:</strong> ${data.content_received.content_type}</p>
                            <p><strong>Size:</strong> ${data.content_received.size_mb}</p>
                            <p><strong>Received At:</strong> ${new Date(data.content_received.received_at).toLocaleTimeString()}</p>
                        </div>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = `
                <div class="cache-indicator ${statusClass}">
                    <i class="fas fa-${(data.status === 'HIT' || data.status === 'Hit') ? 'check-circle' : 'times-circle'} me-2"></i>
                    Cache ${data.status === 'HIT' ? 'HIT' : 'MISS'} - Delivered from ${data.delivery_source}
                </div>
                <div class="mt-3" style="color: var(--text-light);">
                    <p><strong>Satellite:</strong> ${data.satellite} ${data.satellite_connected ? '<span style="color: var(--success-color);">✓ Connected</span>' : '<span style="color: var(--accent-color);">✗ Disconnected</span>'}</p>
                    <p><strong>Delivery Time:</strong> ${data.delivery_time.toFixed(2)}s</p>
                    <p><strong>Cache Utilization:</strong> ${(data.cache_utilization * 100).toFixed(1)}%</p>
                    <p><strong>Hit Rate:</strong> ${data.hit_rate.toFixed(1)}%</p>
                </div>
                ${stepsHtml}
                ${contentReceivedHtml}
            `;
        }
        
        // Update real-time stats
        function updateStats(data) {
            const hitRate = (data.hit_rate || 0).toFixed(1);
            const cacheUtil = (data.cache_utilization * 100).toFixed(1);
            
            animateNumberUpdate('hitRate', hitRate + '%');
            animateNumberUpdate('cacheUtil', cacheUtil + '%');
            
            document.getElementById('hitRateBar').style.width = hitRate + '%';
            document.getElementById('cacheUtilBar').style.width = cacheUtil + '%';
        }
        
        // Animate number update
        function animateNumberUpdate(elementId, value) {
            const element = document.getElementById(elementId);
            element.textContent = value;
            element.classList.add('updated');
            setTimeout(() => element.classList.remove('updated'), 500);
        }
        
        // Animate content stream
        function animateContentStream() {
            const stream = document.getElementById('contentStream');
            stream.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'stream-bar';
                bar.style.left = (i * 5) + '%';
                bar.style.animationDelay = (i * 0.05) + 's';
                stream.appendChild(bar);
            }
        }
        
        // Load satellite status and connection info
        async function loadSatelliteStatus() {
            try {
                const response = await fetch('/api/satellite_status');
                const data = await response.json();
                
                // Update connection status
                const connectionStatus = document.getElementById('connectionStatus');
                const satelliteIndicator = document.getElementById('satelliteIndicator');
                
                if (data.satellites && data.satellites.length > 0) {
                    const sat = data.satellites[0];
                    
                    // Update connection indicator
                    connectionStatus.textContent = `Connected to ${sat.satellite_id}`;
                    connectionStatus.style.color = 'var(--success-color)';
                    satelliteIndicator.className = 'status-indicator status-running';
                    
                    // Update satellite info
                    document.getElementById('satelliteInfo').textContent = 
                        `${sat.satellite_id} • Altitude: ${sat.altitude || 550} km • Status: Active`;
                    
                    // Update satellite status panel
                    document.getElementById('satelliteStatus').innerHTML = `
                        <div style="color: var(--text-light);">
                            <p style="margin-bottom: 10px;">
                                <strong style="color: var(--secondary-color);">${sat.name || sat.satellite_id}</strong>
                                <span class="badge bg-success ms-2">Active</span>
                            </p>
                            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <p style="margin: 5px 0;"><strong>Cache Utilization:</strong> ${(sat.cache_utilization * 100).toFixed(1)}%</p>
                                <p style="margin: 5px 0;"><strong>Hit Rate:</strong> ${sat.hit_rate.toFixed(1)}%</p>
                                <p style="margin: 5px 0;"><strong>Cached Items:</strong> ${sat.cached_items}/${sat.cache_size || 12}</p>
                                <p style="margin: 5px 0;"><strong>Total Requests:</strong> ${sat.total_requests}</p>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">
                                <p style="margin: 3px 0;"><i class="fas fa-satellite me-1"></i>LEO Constellation</p>
                                <p style="margin: 3px 0;"><i class="fas fa-signal me-1"></i>Signal: Strong</p>
                                <p style="margin: 3px 0;"><i class="fas fa-clock me-1"></i>Latency: ~15ms</p>
                            </div>
                        </div>
                    `;
                } else {
                    connectionStatus.textContent = 'Not Connected';
                    connectionStatus.style.color = 'var(--accent-color)';
                    satelliteIndicator.className = 'status-indicator status-stopped';
                    document.getElementById('satelliteStatus').innerHTML = 
                        '<p style="color: var(--text-muted);">Satellite status unavailable</p>';
                }
            } catch (error) {
                console.error('Error loading satellite status:', error);
                document.getElementById('connectionStatus').textContent = 'Connection Error';
                document.getElementById('connectionStatus').style.color = 'var(--accent-color)';
            }
        }
        
        // Load users for messaging
        async function loadUsers() {
            try {
                const response = await fetch('/api/get_users');
                const data = await response.json();
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                
                data.users.forEach(user => {
                    const userItem = document.createElement('a');
                    userItem.href = '#';
                    userItem.className = 'list-group-item list-group-item-action';
                    userItem.style.background = 'transparent';
                    userItem.style.border = 'none';
                    userItem.style.color = 'var(--text-light)';
                    userItem.textContent = user.username;
                    userItem.onclick = (e) => {
                        e.preventDefault();
                        loadMessages(user.id);
                        // Highlight selected user
                        document.querySelectorAll('#usersList a').forEach(a => a.classList.remove('active'));
                        userItem.classList.add('active');
                    };
                    usersList.appendChild(userItem);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        let selectedUserId = null;
        
        // Load messages
        async function loadMessages(userId) {
            selectedUserId = userId;
            try {
                const response = await fetch('/api/get_messages');
                const data = await response.json();
                
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                const currentUserId = parseInt('{{ current_user.id }}');
                const userMessages = data.messages.filter(m => 
                    (m.sender_id === userId && m.receiver_id === currentUserId) ||
                    (m.receiver_id === userId && m.sender_id === currentUserId)
                );
                
                if (userMessages.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center" style="color: var(--text-muted); padding: 20px;">No messages yet. Start the conversation!</p>';
                } else {
                    // Sort by created_at (oldest first)
                    userMessages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    
                    userMessages.forEach(msg => {
                        const bubble = document.createElement('div');
                        bubble.className = `message-bubble ${msg.is_sent ? 'message-sent' : 'message-received'}`;
                        
                        const time = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const senderName = msg.is_sent ? 'You' : msg.sender_username || 'User';
                        
                        bubble.innerHTML = `
                            <div style="font-weight: 600; margin-bottom: 5px; font-size: 0.85rem;">
                                ${senderName}
                            </div>
                            <div style="margin-bottom: 3px;">${msg.message}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7; text-align: right;">
                                ${time}
                            </div>
                        `;
                        container.appendChild(bubble);
                    });
                }
                
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '<p class="text-danger text-center">Error loading messages. Please try again.</p>';
            }
        }
        
        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                alert('Please enter a message');
                return;
            }
            
            if (!selectedUserId) {
                alert('Please select a user first');
                return;
            }
            
            try {
                const response = await fetch('/api/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        receiver_id: selectedUserId,
                        message: message
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    input.value = '';
                    // Reload messages to show the new one
                    loadMessages(selectedUserId);
                } else {
                    alert('Error: ' + (data.error || 'Failed to send message'));
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
            }
        }
        
        // Allow Enter key to send message (set up after DOM loads)
        function setupMessageInput() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                // Remove existing listeners
                const newInput = messageInput.cloneNode(true);
                messageInput.parentNode.replaceChild(newInput, messageInput);
                
                // Add Enter key listener
                document.getElementById('messageInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }
        
        // Share content
        function shareContent() {
            // TODO: Implement content sharing modal
            alert('Content sharing feature - Select a user to share with');
        }
        
        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Multi-Satellite Functions
        async function enableMultiSatellite() {
            const numSatellites = parseInt(document.getElementById('numSatellites').value);
            showLoading();
            
            try {
                const response = await fetch('/api/enable_multi_satellite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ num_satellites: numSatellites })
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    document.getElementById('constellationStatus').innerHTML = `
                        <div style="background: rgba(39, 174, 96, 0.2); border: 2px solid var(--success-color); border-radius: 10px; padding: 15px;">
                            <h6 style="color: var(--success-color); margin-bottom: 10px;">
                                <i class="fas fa-check-circle me-2"></i>Multi-Satellite Mode Enabled!
                            </h6>
                            <p style="color: var(--text-light); margin: 0;">
                                ${numSatellites} satellites are now active in the constellation.
                            </p>
                        </div>
                    `;
                    loadConstellationStats();
                    visualizeConstellation(data.constellation_stats);
                } else {
                    alert('Error: ' + (data.error || 'Failed to enable multi-satellite mode'));
                }
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        }
        
        async function loadConstellationStats() {
            try {
                const response = await fetch('/api/constellation_stats');
                const data = await response.json();
                
                if (data.total_satellites > 0) {
                    document.getElementById('constellationStatsPanel').innerHTML = `
                        <div style="color: var(--text-light);">
                            <div class="mb-3">
                                <strong>Total Satellites:</strong> ${data.total_satellites}
                            </div>
                            <div class="mb-3">
                                <strong>Total Requests:</strong> ${data.total_requests}
                            </div>
                            <div class="mb-3">
                                <strong>Overall Hit Rate:</strong> ${data.overall_hit_rate.toFixed(1)}%
                            </div>
                            <div class="mb-3">
                                <strong>Inter-Satellite Hits:</strong> ${data.inter_satellite_hits}
                            </div>
                            <div>
                                <strong>Inter-Satellite Hit Rate:</strong> ${data.inter_satellite_hit_rate.toFixed(1)}%
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading constellation stats:', error);
            }
        }
        
        function visualizeConstellation(stats) {
            const container = document.getElementById('constellationVisualization');
            if (!stats || !stats.satellites) return;
            
            container.innerHTML = `
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px;">
                    <h6 style="color: var(--text-light); margin-bottom: 15px;">Satellite Positions:</h6>
                    <div class="row">
                        ${stats.satellites.map(sat => `
                            <div class="col-md-6 mb-3">
                                <div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(52, 152, 219, 0.3);">
                                    <h6 style="color: var(--secondary-color); margin-bottom: 10px;">
                                        <i class="fas fa-satellite me-2"></i>${sat.id}
                                    </h6>
                                    <div style="color: var(--text-light); font-size: 0.9rem;">
                                        <p style="margin: 3px 0;"><strong>Position:</strong> Lat ${sat.position.latitude.toFixed(1)}°, Lon ${sat.position.longitude.toFixed(1)}°</p>
                                        <p style="margin: 3px 0;"><strong>Altitude:</strong> ${sat.position.altitude.toFixed(0)} km</p>
                                        <p style="margin: 3px 0;"><strong>Hit Rate:</strong> ${sat.hit_rate.toFixed(1)}%</p>
                                        <p style="margin: 3px 0;"><strong>Requests:</strong> ${sat.total_requests}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Handle simulation form
        document.getElementById('simulationForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const config = {};
            for (let [key, value] of formData.entries()) {
                config[key] = value;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/start_simulation', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                hideLoading();
                
                if (data.success) {
                    alert('Simulation started! Check Analytics tab for results after completion.');
                } else {
                    alert('Error: ' + (data.error || 'Failed to start simulation'));
                }
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // Initialize analytics charts
        let performanceChart = null;
        let contentChart = null;
        
        async function initializeAnalyticsCharts() {
            try {
                // Get simulation results or use default data
                const response = await fetch('/simulation_results');
                let data;
                
                if (response.ok) {
                    data = await response.json();
                } else {
                    // Use default/empty data if no simulation results
                    data = {
                        statistics: {
                            hit_rate: 0,
                            cache_utilization: 0,
                            total_requests: 0
                        },
                        charts: {}
                    };
                }
                
                // Initialize Performance Chart
                const perfCtx = document.getElementById('performanceChart');
                if (perfCtx && typeof Chart !== 'undefined') {
                    const perfCanvas = perfCtx.getContext('2d');
                    
                    // Get performance data from simulation or create sample
                    let hitRateData = [];
                    let cacheUtilData = [];
                    let labels = [];
                    
                    if (data.statistics && data.statistics.hit_rate !== undefined) {
                        // Use actual data if available
                        hitRateData = [data.statistics.hit_rate || 0];
                        cacheUtilData = [(data.statistics.cache_utilization || 0) * 100];
                        labels = ['Current'];
                    } else {
                        // Sample data for demonstration
                        for (let i = 0; i < 10; i++) {
                            labels.push(`T${i + 1}`);
                            hitRateData.push(Math.random() * 30 + 40); // 40-70%
                            cacheUtilData.push(Math.random() * 40 + 30); // 30-70%
                        }
                    }
                    
                    performanceChart = new Chart(perfCanvas, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Hit Rate (%)',
                                data: hitRateData,
                                borderColor: '#00d4ff',
                                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: 'Cache Utilization (%)',
                                data: cacheUtilData,
                                borderColor: '#00ff88',
                                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    labels: { color: '#ecf0f1' }
                                },
                                title: {
                                    display: true,
                                    text: 'Performance Over Time',
                                    color: '#ecf0f1'
                                }
                            },
                            scales: {
                                x: { 
                                    ticks: { color: '#ecf0f1' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                                },
                                y: { 
                                    ticks: { color: '#ecf0f1' },
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    min: 0,
                                    max: 100
                                }
                            }
                        }
                    });
                }
                
                // Initialize Content Distribution Chart
                const contentCtx = document.getElementById('contentChart');
                if (contentCtx && typeof Chart !== 'undefined') {
                    const contentCanvas = contentCtx.getContext('2d');
                    
                    // Sample content distribution data
                    const contentData = {
                        labels: ['Video', 'Image', 'Document', 'Audio', 'Other'],
                        data: [35, 25, 20, 15, 5]
                    };
                    
                    contentChart = new Chart(contentCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: contentData.labels,
                            datasets: [{
                                data: contentData.data,
                                backgroundColor: [
                                    'rgba(52, 152, 219, 0.8)',
                                    'rgba(39, 174, 96, 0.8)',
                                    'rgba(243, 156, 18, 0.8)',
                                    'rgba(155, 89, 182, 0.8)',
                                    'rgba(231, 76, 60, 0.8)'
                                ],
                                borderColor: [
                                    '#3498db',
                                    '#27ae60',
                                    '#f39c12',
                                    '#9b59b6',
                                    '#e74c3c'
                                ],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#ecf0f1' }
                                },
                                title: {
                                    display: true,
                                    text: 'Content Type Distribution',
                                    color: '#ecf0f1'
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error initializing charts:', error);
                // Show error message in chart containers
                const perfCtx = document.getElementById('performanceChart');
                const contentCtx = document.getElementById('contentChart');
                if (perfCtx) {
                    perfCtx.parentElement.innerHTML = '<p class="text-muted text-center">No data available. Run a simulation first.</p>';
                }
                if (contentCtx) {
                    contentCtx.parentElement.innerHTML = '<p class="text-muted text-center">No data available. Run a simulation first.</p>';
                }
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initAnimatedBackground();
            initNetworkVisualization();
            loadSatelliteStatus();
            loadUsers();
            loadAvailableContent(); // Load content catalog
            setupMessageInput(); // Setup message input Enter key
            initializeAnalyticsCharts(); // Initialize charts
            
            // Update stats periodically
            setInterval(loadSatelliteStatus, 5000);
            
            // Check satellite connection on load
            setTimeout(() => {
                loadSatelliteStatus();
            }, 1000);
            
            // Setup message input when modal opens
            const messagesModal = document.getElementById('messagesModal');
            if (messagesModal) {
                messagesModal.addEventListener('shown.bs.modal', function() {
                    setupMessageInput();
                    loadUsers(); // Refresh users list
                });
            }
            
            // Reinitialize charts when Analytics tab is shown
            const analyticsTab = document.querySelector('[data-bs-target="#analytics"]');
            if (analyticsTab) {
                analyticsTab.addEventListener('shown.bs.tab', function() {
                    if (!performanceChart || !contentChart) {
                        initializeAnalyticsCharts();
                    }
                });
            }
        });
    </script>
</body>
</html>

